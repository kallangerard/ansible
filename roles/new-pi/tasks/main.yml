---
# tasks file for new-pi
# Expand filesystem to fill SD Card
- name: Expanding Filesystem
  command: raspi-config --expand-rootfs
    
- name: Configure localisation
  tasks:
    - name: Ensure locale exists
      locale_gen:
        name: "{{ locale }}"
        state: present
    - name: Removing default GB locale
      locale_gen:
        name: en_GB.UTF-8
        state: absent

- name: Set timezone
  timezone:
    name: "{{ timezone }}"

- name: Update apt packages
  apt:
    update_cache: yes
    cache_valid_time: 3600

- name: Upgrade apt packages
  apt:
    upgrade: dist

- name: Configure wifi
  tasks:
    - name: Set Country Code
      lineinfile:
        path: /etc/wpa_supplicant/wpa_supplicant.conf
        regex: "^country="
        line: "country={{ wifi_country }}"
        state: present

    - name: Configure SSID and Password
      blockinfile:
        path: /etc/wpa_supplicant/wpa_supplicant.conf
        block: |
          network={
              ssid="{{ wifi_ssid }}"
              psk="{{ wifi_password }}"
              scan_ssid=1
          }

- name: Changing hostname
  hostname:
    name: "{{ hostname }}"

- name: update firmware
  include: update-firmware.yml